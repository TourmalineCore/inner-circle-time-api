image:
  registry: ghcr.io
  repository: tourmalinecore/inner-circle-time-api
  pullPolicy: Always
  debug: false

  # ToDo implement working probes
  livenessProbe:
    enabled: false
  readinessProbe:
    enabled: false
    
  pullSecrets: []
  pullCredentials: {}

# Here you need to pass your application dll to the dotnet utility
args:
  - "Api.dll"

## @param bindURLs URLs to bind
##
bindURLs: http://+:80

podAnnotations:
  # this is needed to trigger re-deploy when only Config Map is changed
  # that is the file name generated by extraDeploy nginx/templates/extra-list.yaml
  # that is why it looks so weird in the file path to calculate hash by its content
  checksum/config: "{{ include (print $.Template.BasePath \"/extra-list.yaml\") . | sha256sum }}"

# CUSTOM: Here you store non secret env vars that will be passed to the pod's environment
extraConfigMapEnvVars:
  AuthenticationOptions__IsDebugTokenEnabled: "false"
  ENABLE_EXCEPTION_DETAILS: "false"

# CUSTOM: Here you store secret env vars that will be passed to the pod's environment. You should never store them in this file.
extraSecretEnvVars: {}

extraSecretEnvVarsEncoded: |
  {{- range $k, $v := .Values.extraSecretEnvVars }}
  {{- if kindIs "int64" $v}}
  {{ $k }}: {{ $v | quote | b64enc | quote}}
  {{- else}}
  {{ $k }}: {{ $v | b64enc | quote}}
  {{- end}}
  {{- end }}

# this is needed to tell the container to read extra env vars from the dedicated Config Map that we create in extraDeploy
extraEnvVarsCM: "{{ include \"common.names.fullname\" . }}"
# this is needed to tell the container to read extra env vars from the dedicated Secret that we create in extraDeploy
extraEnvVarsSecret: "{{ include \"common.names.fullname\" . }}"

replicaCount: 1

# 1000m means 100% of processor time 
# 1m means 0.1% of processor time.
# at start pod is being allocated with resources from requests, if it needs more consumption can grow until limits.
# if pod uses more resources than limits in spite of the reason kube-system will perform a forced restart
resources:
  limits:
    cpu: 150m
    memory: 250Mi
  requests:
    cpu: 1m
    memory: 250Mi

## @param containerPorts.http Port to expose at ASP.NET Core container level
##
containerPorts:
  http: 80

## Enable to download/build ASP.NET Core app from external git repository.
## Do not enable it if your docker image already includes your application
##
appFromExternalRepo:
  ## @param appFromExternalRepo.enabled Enable to download/build ASP.NET Core app from external git repository
  ##
  enabled: false

service:
  type: ClusterIP
  ports:
    http: 80

## Configure the ingress resource that allows you to access the ASP.NET Core app
## ref: https://kubernetes.io/docs/user-guide/ingress/
##
ingress:
  enabled: true
  pathType: ImplementationSpecific
  apiVersion: ""
  path: /api/time(/|$)(.*)
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/rewrite-target: /api/time/$2
  tls: true
  ingressClassName: nginx

extraDeploy:
  - |
    apiVersion: v1
    kind: ConfigMap
    metadata:
      name: {{ include "common.names.fullname" . }}
      namespace: {{ include "common.names.namespace" . | quote }}
      labels: {{- include "common.labels.standard" . | nindent 6 }}
        {{- if .Values.commonLabels }}
        {{- include "common.tplvalues.render" ( dict "value" .Values.commonLabels "context" $ ) | nindent 6 }}
        {{- end }}
      {{- if .Values.commonAnnotations }}
      annotations: {{- include "common.tplvalues.render" ( dict "value" .Values.commonAnnotations "context" $ ) | nindent 6 }}
      {{- end }}
    data:
      {{- if .Values.extraConfigMapEnvVars }}
      {{- include "common.tplvalues.render" ( dict "value" .Values.extraConfigMapEnvVars "context" $ ) | nindent 6 }}
      {{- end }}
  - |
    {{ $secret_name := printf "%s" ( include "common.names.fullname" .) }}
    {{- if eq ( tpl .Values.extraEnvVarsSecret . ) $secret_name }}
    apiVersion: v1
    kind: Secret
    metadata:
      name: {{ $secret_name }}
      namespace: {{ include "common.names.namespace" . | quote }}
      labels: {{- include "common.labels.standard" . | nindent 6 }}
        {{- if .Values.commonLabels }}
        {{- include "common.tplvalues.render" ( dict "value" .Values.commonLabels "context" $ ) | nindent 6 }}
        {{- end }}
      {{- if .Values.commonAnnotations }}
      annotations: {{- include "common.tplvalues.render" ( dict "value" .Values.commonAnnotations "context" $ ) | nindent 6 }}
      {{- end }}
    type: Opaque
    data:
      {{- if .Values.extraSecretEnvVarsEncoded }}
      {{- include "common.tplvalues.render" ( dict "value" .Values.extraSecretEnvVarsEncoded "context" $ ) | trim | nindent 6 }}
      {{- end }}
    {{- end }}
