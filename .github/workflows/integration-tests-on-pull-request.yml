name: Integration Tests

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  integration-tests:
    name: Run integration tests
    runs-on: ubuntu-24.04
    steps:
      - name: Check out the repo
        uses: actions/checkout@v4 

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      # this is needed to address this issue according to the comment https://github.com/devcontainers/ci/issues/271#issuecomment-2301764487
      # otherwise our TourmalineCore org name cannot be used in docker image names, only tourmalinecore
      - name: Add Lowercase Organization and Repo Name REPO_NAME Env Var
        run: |
          echo "DEV_CONTAINER_IMAGE=${GITHUB_REPOSITORY,,}-devcontainer" >>${GITHUB_ENV}

      - name: Run integration tests
        uses: devcontainers/ci@v0.3
        with:
          imageName: ghcr.io/${{ env.DEV_CONTAINER_IMAGE }}
          cacheFrom: ghcr.io/${{ env.DEV_CONTAINER_IMAGE }}
          runCmd: dotnet test --filter "Type=Integration"
